<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Đơn hàng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="fixed inset-0 bg-gray-800/70 backdrop-blur-sm z-50 flex justify-center items-center hidden transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center animate-pulse">
            <div class="text-blue-600 mb-4">
                <i class="fas fa-circle-notch fa-spin text-5xl"></i>
            </div>
            <p class="text-gray-700 font-medium text-lg" id="loadingText">Đang xử lý...</p>
        </div>
    </div>

    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-blue-600 text-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <!-- Nút hiển thị sidebar cho thiết bị di động -->
                    <button id="mobileSidebarToggle" class="mr-2 md:hidden text-white">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h1 class="text-xl font-bold">Hệ Thống Quản Lý Đơn Hàng</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button type="button" id="resetFormBtn"
                        class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition duration-300">
                        <i class="fas fa-redo-alt mr-2"></i><span class="hidden sm:inline">Làm mới</span>
                    </button>
                    <button id="saveAll"
                        class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition duration-300">
                        <i class="fas fa-save mr-2"></i><span class="hidden sm:inline">Lưu</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content with Sidebar -->
        <div class="flex flex-grow relative">
            <!-- Overlay cho thiết bị di động khi sidebar mở -->
            <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

            <!-- Sidebar - Fixed position -->
            <div id="sidebar"
                class="w-80 bg-white border-r border-gray-200 overflow-hidden transition-all duration-300 fixed md:sticky top-0 z-30 h-screen transform -translate-x-full md:translate-x-0">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
                    <h2 class="font-semibold text-gray-700">Danh Mục Sản Phẩm</h2>
                    <button id="toggleSidebar" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <!-- Nút đóng cho thiết bị di động -->
                    <button id="closeMobileSidebar" class="text-gray-500 hover:text-gray-700 md:hidden">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="overflow-y-auto" style="height: calc(100vh - 70px);">
                    <!-- Search Bar -->
                    <div class="p-4 border-b border-gray-200">
                        <div class="relative">
                            <input type="text" id="productSearch"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Tìm kiếm hàng hóa...">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>

                    <!-- Sửa phần HTML ở section barcode -->
                    <div class="p-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="font-medium text-sm text-gray-500 uppercase">Quét mã Barcode</h3>
                        </div>
                        <div class="mt-2">
                            <div class="relative">
                                <input type="text" id="barcodeInput"
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Quét hoặc nhập mã barcode...">
                                <i class="fas fa-barcode absolute left-3 top-3 text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Product Categories -->
                    <div class="p-4 border-b border-gray-200">
                        <div class="flex justify-between items-center cursor-pointer" id="categoryHeader">
                            <h3 class="font-medium text-sm text-gray-500 uppercase">Phân Loại</h3>
                            <button class="text-gray-500 focus:outline-none">
                                <i class="fas fa-chevron-down" id="categoryToggleIcon"></i>
                            </button>
                        </div>
                        <div id="categoryContent" class="mt-2 max-h-24 overflow-y-auto">
                            <div id="categoryContainer" class="flex flex-wrap gap-2">
                                <!-- Các nút phân loại sẽ được thêm động bằng JavaScript -->
                                <button class="px-3 py-1 rounded bg-blue-500 text-white font-medium category-filter"
                                    data-category="all">Tất cả</button>
                                <!-- Các phân loại khác sẽ được thêm từ dữ liệu -->
                            </div>
                            <div class="mt-2 text-xs text-blue-500 cursor-pointer" id="showAllCategories">
                                <span>Xem tất cả phân loại</span>
                            </div>
                        </div>
                    </div>

                    <!-- Product List -->
                    <div class="p-4">
                        <ul id="productList" class="divide-y divide-gray-200">
                            <!-- Product items will be dynamically loaded here -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Toggle button for collapsed sidebar -->
            <div id="sidebarCollapsed" class="hidden md:block">
                <button id="expandSidebar"
                    class="fixed left-0 top-1/2 transform -translate-y-1/2 bg-white p-2 rounded-r-lg shadow-md text-gray-500 hover:text-gray-700 border border-l-0 border-gray-200 z-10">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Main Content -->
            <main class="flex-grow w-full md:w-auto">
                <div class="container mx-auto px-4 py-6">
                    <!-- Thông tin khách hàng -->
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-user mr-2 text-blue-500"></i>
                            Thông tin khách hàng
                        </h2>

                        <form id="donHangForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mã đơn hàng</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <i class="fas fa-barcode text-gray-400"></i>
                                    </div>
                                    <input type="text" id="maDonHang"
                                        class="w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50"
                                        readonly>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Khách hàng <span
                                        class="text-red-500">*</span></label>
                                <div class="flex gap-2">
                                    <div class="relative flex-1">
                                        <div
                                            class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-user text-gray-400"></i>
                                        </div>
                                        <select id="khachHang"
                                            class="w-full pl-10 pr-9 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none"
                                            required>
                                            <option value="">-- Chọn khách hàng --</option>
                                        </select>
                                        <div
                                            class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-chevron-down text-gray-400"></i>
                                        </div>
                                    </div>
                                    <button type="button" id="btnThemKhachHang"
                                        class="px-3 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ngày bán <span
                                        class="text-red-500">*</span></label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <i class="fas fa-calendar-alt text-gray-400"></i>
                                    </div>
                                    <input type="date" id="ngayDatHang"
                                        class="w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nhân viên bán hàng</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <i class="fas fa-user-tie text-gray-400"></i>
                                    </div>
                                    <select id="nhanVienBanHang"
                                        class="w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">-- Chọn nhân viên --</option>
                                        <!-- Các option sẽ được tải động từ API -->
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ghi chú</label>
                                <div class="relative">
                                    <div class="absolute top-3 left-3 pointer-events-none">
                                        <i class="fas fa-sticky-note text-gray-400"></i>
                                    </div>
                                    <select id="ghiChu"
                                        class="w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="QUA NHÀ LẤY">QUA NHÀ LẤY</option>
                                        <option value="GỬI HÀNG TK">GỬI HÀNG TK</option>
                                        <option value="KO THU TIỀN">KO THU TIỀN</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ngày giao hàng dự
                                    kiến</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <i class="fas fa-calendar-alt text-gray-400"></i>
                                    </div>
                                    <input type="date" id="ngayGiaoHangDuKien"
                                        class="w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Chi tiết hàng hóa -->
                    <div id="chiTietSection" class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-700 flex items-center">
                                <i class="fas fa-table-list mr-2 text-blue-500"></i>
                                Chi tiết hàng hóa
                            </h2>
                        </div>

                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table id="chiTietTable" class="min-w-full divide-y divide-gray-200">
                                <thead id="chiTietTableHead">
                                    <tr class="bg-gray-50">
                                        <th
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            STT</th>
                                        <th
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            SKU</th>
                                        <th
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Tên sản phẩm</th>
                                        <th
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ĐVT</th>
                                        <th
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Số lượng</th>
                                        <th
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Đơn giá</th>
                                        <th
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Thành tiền</th>
                                        <th
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Phân loại giá</th>
                                        <th
                                            class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Ghi chú</th>
                                        <th
                                            class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="chiTietTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Các dòng sẽ được thêm qua JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <div class="flex justify-between items-center mt-6">
                            <span id="dataStatusText" class="text-sm text-gray-500"></span>
                            <div class="flex space-x-3">
                                <button type="button" id="cancelBtn"
                                    class="px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-200 flex items-center">
                                    <i class="fas fa-times mr-2"></i> Hủy
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tổng hợp đơn hàng và thanh toán -->
                    <div id="paymentSummarySection" class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-calculator mr-2 text-blue-500"></i>
                            Thông tin thanh toán
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="grid grid-cols-1 gap-4">
                                <!-- Các trường thanh toán đã chuyển từ phần trên -->
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Phân loại giảm
                                        giá</label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-tags text-gray-400"></i>
                                        </div>
                                        <select id="phanLoaiGiamGia"
                                            class="w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="Không giảm giá">Không giảm giá</option>
                                            <option value="Giảm giá theo tiền">Theo tiền</option>
                                            <option value="Giảm giá theo phần trăm">Theo phần trăm</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Giảm giá theo
                                        tiền</label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-money-bill-wave text-gray-400"></i>
                                        </div>
                                        <input type="text" id="giamGiaTheoTien"
                                            class="w-full pl-10 pr-10 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            value="0">
                                        <div
                                            class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <span class="text-gray-500 text-sm">VNĐ</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Giảm giá theo %</label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-percent text-gray-400"></i>
                                        </div>
                                        <input type="number" id="giamGiaTheoPhanTram"
                                            class="w-full pl-10 pr-8 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            value="0" min="0" max="100">
                                        <div
                                            class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <span class="text-gray-500 text-sm">%</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Đã thanh toán</label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-check-circle text-gray-400"></i>
                                        </div>
                                        <input type="text" id="daThanhToan"
                                            class="w-full pl-10 pr-10 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            value="0">
                                        <div
                                            class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <span class="text-gray-500 text-sm">VNĐ</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Trạng thái</label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-clipboard-check text-gray-400"></i>
                                        </div>
                                        <select id="trangThai"
                                            class="w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="Chốt order">Chốt order</option>
                                            <option value="Giao thành công">Giao thành công</option>
                                            <option value="Đơn hàng chờ xử lý">Đơn hàng chờ xử lý</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Phương thức thanh
                                        toán</label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-credit-card text-gray-400"></i>
                                        </div>
                                        <select id="phuongThucThanhToan"
                                            class="w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="ĐÃ THANH TOÁN">ĐÃ THANH TOÁN</option>
                                            <option value="CÔNG NỢ">CÔNG NỢ</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Hình thức thanh
                                        toán</label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i class="fas fa-money-bill text-gray-400"></i>
                                        </div>
                                        <select id="paymentMethod"
                                            class="w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="Tiền mặt">Tiền mặt</option>
                                            <option value="Chuyển khoản">Chuyển khoản</option>
                                            <option value="Thẻ tín dụng">Thẻ tín dụng</option>
                                            <option value="Ví điện tử">Ví điện tử</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ghi chú thanh
                                        toán</label>
                                    <textarea id="paymentNote"
                                        class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        rows="3" placeholder="Ghi chú về thanh toán..."></textarea>
                                </div>
                            </div>

                            <div>
                                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                    <div class="form-group mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Tổng tiền
                                            hàng</label>
                                        <div class="relative">
                                            <div
                                                class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                                <i class="fas fa-money-bill-wave text-gray-400"></i>
                                            </div>
                                            <input type="text" id="tongTienHang"
                                                class="w-full pl-10 pr-10 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50"
                                                readonly>
                                            <div
                                                class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                <span class="text-gray-500 text-sm">VNĐ</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Phí ship</label>
                                        <div class="relative">
                                            <div
                                                class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                                <i class="fas fa-truck text-gray-400"></i>
                                            </div>
                                            <select id="phiShip"
                                                class="w-full pl-10 pr-10 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="10000">10,000</option>
                                                <option value="15000">15,000</option>
                                                <option value="20000">20,000</option>
                                            </select>
                                            <div
                                                class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                <span class="text-gray-500 text-sm">VNĐ</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Giảm giá</label>
                                        <div class="relative">
                                            <div
                                                class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                                <i class="fas fa-tag text-gray-400"></i>
                                            </div>
                                            <input type="text" id="giamGia"
                                                class="w-full pl-10 pr-10 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50"
                                                value="0" readonly>
                                            <div
                                                class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                <span class="text-gray-500 text-sm">VNĐ</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Còn phải thanh
                                            toán</label>
                                        <div class="relative">
                                            <div
                                                class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                                <i class="fas fa-coins text-gray-400"></i>
                                            </div>
                                            <input type="text" id="conlaiPhaithanhtoan"
                                                class="w-full pl-10 pr-10 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 font-bold text-lg"
                                                readonly>
                                            <div
                                                class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                <span class="text-gray-500 text-sm">VNĐ</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="flex justify-between py-2 border-b border-gray-200">
                                        <span class="text-gray-600">Tổng tiền hàng:</span>
                                        <span id="totalBeforeDiscount" class="font-medium">0 đ</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-gray-200">
                                        <span class="text-gray-600">Giảm giá:</span>
                                        <span id="totalDiscount" class="font-medium text-red-500">0 đ</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-gray-200">
                                        <span class="text-gray-600">Phí giao hàng:</span>
                                        <span id="shippingFeeDisplay" class="font-medium">0 đ</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-gray-200">
                                        <span class="text-gray-600">Đã thanh toán:</span>
                                        <span id="paidAmountDisplay" class="font-medium">0 đ</span>
                                    </div>
                                    <div class="flex justify-between py-3 font-bold text-lg">
                                        <span class="text-gray-800">CÒN PHẢI THANH TOÁN:</span>
                                        <span id="remainingTotal" class="text-blue-600">0 đ</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Thêm Khách Hàng -->
    <div id="themKhachHangModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <!-- Overlay -->
            <div class="fixed inset-0 bg-black opacity-50 transition-opacity" id="modalOverlay"></div>

            <!-- Modal content -->
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full z-10 relative">
                <div class="flex justify-between items-center border-b px-6 py-4">
                    <h3 class="text-lg font-medium text-gray-900">Thêm khách hàng mới</h3>
                    <button id="closeKhachHangModal" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="p-6">
                    <form id="khachHangForm">
                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tên khách hàng <span
                                        class="text-red-500">*</span></label>
                                <input type="text" id="tenKhachHang"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Số điện thoại <span
                                        class="text-red-500">*</span></label>
                                <input type="tel" id="soDienThoai"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Địa chỉ</label>
                                <input type="text" id="diaChi"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="email"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" id="cancelKhachHangBtn"
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-200">
                                Hủy
                            </button>
                            <button type="submit" id="saveKhachHangBtn"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                                Lưu
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Cấu hình API AppSheet
            const appSheetConfig = {
                appId: 'f4addc6b-0e3c-4920-a52d-3047369b2ae4',
                accessKey: 'V2-0VqkW-qgxkc-C42EP-aTrK1-SGylq-C5EPN-yt3Nd-pcYie',
                tables: {
                    khachHang: 'Khách hàng',
                    kho: 'Kho',
                    nhanVien: 'DSNV',
                    donHang: 'Bán hàng',
                    chiTietDonHang: 'Chi tiết bán hàng'
                }
            };

            // Biến toàn cục
            let orderItems = [];
            let skuList = [];
            let khachHangList = [];
            let nhanVienList = [];

            // Initialize date fields with current date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ngayDatHang').value = today;
            document.getElementById('ngayGiaoHangDuKien').value = today;

            // Generate a random order ID
            function generateOrderId() {
                const prefix = 'DH';
                const timestamp = Date.now().toString().slice(-6);
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return `${prefix}${timestamp}${random}`;
            }
            document.getElementById('maDonHang').value = generateOrderId();

            // =============== APPSHEET API FUNCTIONS ===============

            // Hiển thị loading
            function showLoading(message = 'Đang xử lý...') {
                document.getElementById('loadingText').textContent = message;
                document.getElementById('loadingOverlay').classList.remove('hidden');
            }

            // Ẩn loading
            function hideLoading() {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }

            // Hiển thị thông báo
            function showAlert(icon, title, text = '') {
                return Swal.fire({
                    icon,
                    title,
                    text,
                    confirmButtonColor: icon === 'error' ? '#d33' : '#3085d6'
                });
            }

            // Thêm các hàm JavaScript sau vào phần script
            // =======================================
            // Thiết lập quét barcode
            function setupBarcodeScanner() {
                // Biến lưu trữ kết quả quét
                let barcodeBuffer = '';
                let lastKeyTime = 0;

                // Thời gian tối đa giữa các phím khi quét (ms)
                const MAX_SCAN_GAP = 50;

                // Sự kiện khi nhấn phím trên toàn trang
                document.addEventListener('keydown', (e) => {
                    // Kiểm tra nếu đang focus vào input text/textarea thì không xử lý
                    if (document.activeElement.tagName === 'INPUT' &&
                        (document.activeElement.type === 'text' ||
                            document.activeElement.type === 'number' ||
                            document.activeElement.type === 'textarea' ||
                            document.activeElement.type === 'email' ||
                            document.activeElement.type === 'tel' ||
                            document.activeElement.type === 'date')) {
                        return;
                    }

                    const currentTime = new Date().getTime();

                    // Nếu thời gian giữa các phím quá lâu, reset buffer
                    if (currentTime - lastKeyTime > MAX_SCAN_GAP && barcodeBuffer.length > 0) {
                        barcodeBuffer = '';
                    }

                    // Cập nhật thời gian nhấn phím cuối
                    lastKeyTime = currentTime;

                    // Nếu là Enter, xử lý mã quét
                    if (e.key === 'Enter' && barcodeBuffer.length > 0) {
                        e.preventDefault();
                        processBarcodeInput(barcodeBuffer);
                        barcodeBuffer = '';
                        return;
                    }

                    // Thêm ký tự vào buffer
                    // Chỉ lấy các ký tự có thể là barcode (số, chữ, dấu gạch, v.v.)
                    if (/[\w\d\-\.\/]/.test(e.key) && e.key.length === 1) {
                        barcodeBuffer += e.key;
                    }
                });
            }

            // Hiển thị thông báo tự động đóng sau một khoảng thời gian
            function showToast(icon, title, text = '', timer = 2000) {
                return Swal.fire({
                    icon,
                    title,
                    text,
                    timer: timer,
                    timerProgressBar: true,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true
                });
            }

            // Xử lý input barcode
            async function processBarcodeInput(barcode) {
                if (!barcode || barcode.length < 3) return;

                console.log('Đã quét barcode:', barcode);
                showLoading('Đang xử lý mã barcode...');

                try {
                    // Tìm sản phẩm theo barcode trong danh sách hiện có
                    const product = skuList.find(item => item.SKU === barcode || item['SKU'] === barcode);

                    if (product) {
                        // Product found, add to order
                        addProductToOrder({
                            id: product['ID'] || product.ID,
                            sku: product['SKU'] || product.SKU,
                            name: product['Tên sản phẩm'] || product.Ten,
                            unit: product['Đvt'] || product.DonViTinh,
                            price: product['Giá lẻ'] || product.GiaBan,
                            priceWholesale: product['Giá sỉ'] || product.GiaSi,
                            category: product['Nhóm Sản Phẩm'] || 'Khác',
                            tonKho: product['Tồn kho'] || product.TonKho || 0
                        });
                        hideLoading();

                        // Sử dụng thông báo toast tự đóng
                        showToast('success',
                            `Đã thêm "${product['Tên sản phẩm'] || barcode}" vào đơn hàng`);
                    } else {
                        // Nếu không tìm thấy, truy vấn API
                        const apiProduct = await findProductBySKU(barcode);
                        hideLoading();

                        if (apiProduct) {
                            addProductToOrder({
                                id: apiProduct['ID'] || apiProduct.ID,
                                sku: apiProduct['SKU'] || apiProduct.SKU,
                                name: apiProduct['Tên sản phẩm'] || apiProduct.Ten,
                                unit: apiProduct['Đvt'] || apiProduct.DonViTinh,
                                price: apiProduct['Giá lẻ'] || apiProduct.GiaBan,
                                priceWholesale: apiProduct['Giá sỉ'] || apiProduct.GiaSi,
                                category: apiProduct['Nhóm Sản Phẩm'] || 'Khác',
                                tonKho: apiProduct['Tồn kho'] || apiProduct.TonKho || 0
                            });
                            showAlert('success', `Đã thêm "${apiProduct['Tên sản phẩm'] || barcode}" vào đơn hàng`);
                        } else {
                            // Tạo dòng trống với mã barcode
                            showAlert('warning', 'Không tìm thấy sản phẩm', 'Không tìm thấy sản phẩm với mã barcode này. Vui lòng thêm sản phẩm mới.');
                        }
                    }
                } catch (error) {
                    console.error('Lỗi khi xử lý barcode:', error);
                    hideLoading();
                    showAlert('error', 'Lỗi', 'Đã xảy ra lỗi khi xử lý mã barcode.');
                }
            }

            // Mở camera để quét barcode
            function openBarcodeScanner() {
                // Kiểm tra xem trình duyệt có hỗ trợ camera không
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showAlert('error', 'Không hỗ trợ', 'Trình duyệt của bạn không hỗ trợ truy cập camera.');
                    return;
                }

                // Tạo modal cho camera
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex flex-col items-center justify-center';
                modal.innerHTML = `
        <div class="bg-white rounded-lg overflow-hidden shadow-xl max-w-md w-full">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-medium">Quét mã barcode</h3>
                <button id="closeScannerBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="relative">
                <video id="scannerVideo" class="w-full h-64 object-cover"></video>
                <div class="absolute top-0 left-0 w-full h-full border-2 border-dashed border-blue-500 pointer-events-none">
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-1 bg-red-500 opacity-50"></div>
                </div>
            </div>
            <div class="p-4 text-center text-sm text-gray-600">
                Đặt mã barcode vào vùng quét và giữ yên
            </div>
        </div>
    `;

                document.body.appendChild(modal);

                // Đóng modal
                const closeBtn = document.getElementById('closeScannerBtn');
                closeBtn.addEventListener('click', () => {
                    stopCamera();
                    modal.remove();
                });

                // Thiết lập camera
                const video = document.getElementById('scannerVideo');
                let stream = null;

                // Bắt đầu camera
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(mediaStream => {
                        stream = mediaStream;
                        video.srcObject = mediaStream;
                        video.onloadedmetadata = () => {
                            video.play();
                            startScanning(video);
                        };
                    })
                    .catch(err => {
                        console.error('Lỗi camera:', err);
                        showAlert('error', 'Lỗi camera', 'Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập camera.');
                        modal.remove();
                    });

                // Dừng camera
                const stopCamera = () => {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                };

                // Thiết lập quét barcode
                const startScanning = (videoElement) => {
                    // Tải thư viện QuaggaJS nếu cần
                    if (typeof Quagga === 'undefined') {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js';
                        script.onload = () => initQuagga(videoElement);
                        document.head.appendChild(script);
                    } else {
                        initQuagga(videoElement);
                    }
                };

                // Khởi tạo thư viện Quagga
                const initQuagga = (videoElement) => {
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: videoElement,
                            constraints: {
                                width: 640,
                                height: 480,
                                facingMode: "environment"
                            },
                        },
                        decoder: {
                            readers: [
                                "code_128_reader",
                                "ean_reader",
                                "ean_8_reader",
                                "code_39_reader",
                                "code_39_vin_reader",
                                "codabar_reader",
                                "upc_reader",
                                "upc_e_reader",
                                "i2of5_reader"
                            ],
                            multiple: false
                        },
                        locate: true
                    }, (err) => {
                        if (err) {
                            console.error('Quagga initialization error:', err);
                            return;
                        }
                        Quagga.start();
                    });

                    // Khi phát hiện barcode
                    Quagga.onDetected((result) => {
                        if (result && result.codeResult && result.codeResult.code) {
                            const barcode = result.codeResult.code;
                            console.log('Barcode detected:', barcode);

                            // Dừng scanner và đóng modal
                            stopCamera();
                            Quagga.stop();
                            modal.remove();

                            // Xử lý mã barcode phát hiện được
                            processBarcodeInput(barcode);
                        }
                    });
                };
            }

            // Thêm sự kiện cho các element barcode
            // Thay thế phần xử lý cho barcode input như sau:
            function setupBarcodeEvents() {
                const barcodeInput = document.getElementById('barcodeInput');
                if (barcodeInput) {
                    barcodeInput.addEventListener('keyup', (e) => {
                        if (e.key === 'Enter') {
                            const barcode = barcodeInput.value.trim();
                            if (barcode) {
                                processBarcodeInput(barcode);
                                barcodeInput.value = '';
                            }
                        }
                    });

                    // Tự động focus vào trường nhập barcode khi trang tải xong
                    barcodeInput.focus();
                }
            }
            // =======================================

            // Kiểm tra kết nối API
            async function testAppSheetConnection() {
                try {
                    showLoading('Đang kiểm tra kết nối...');

                    const response = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${appSheetConfig.appId}/tables/${appSheetConfig.tables.khachHang}/Action`,
                        headers: {
                            'ApplicationAccessKey': appSheetConfig.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Find",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh",
                                "Selector": `Select(${appSheetConfig.tables.khachHang})`,
                                "MaxRecords": 1
                            }
                        }
                    });

                    hideLoading();

                    if (response.status === 200) {
                        console.log('Kết nối API thành công:', response);
                        return true;
                    } else {
                        throw new Error('Phản hồi không thành công');
                    }
                } catch (error) {
                    hideLoading();
                    console.error('Lỗi kết nối API:', error);

                    let errorMessage = 'Không thể kết nối đến AppSheet API.';
                    if (error.response) {
                        errorMessage += ` Status: ${error.response.status}. ${error.response.data?.error || ''}`;
                    }

                    showAlert('error', 'Lỗi kết nối!', errorMessage);
                    return false;
                }
            }

            // Tải danh sách khách hàng
            async function loadKhachHangList() {
                try {
                    showLoading('Đang tải danh sách khách hàng...');

                    const response = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${appSheetConfig.appId}/tables/${appSheetConfig.tables.khachHang}/Action`,
                        headers: {
                            'ApplicationAccessKey': appSheetConfig.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Find",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh",
                                "Selector": `Filter(${appSheetConfig.tables.khachHang}, true)`
                            }
                        }
                    });

                    if (response.data && response.data.Rows) {
                        khachHangList = response.data.Rows;
                    } else if (Array.isArray(response.data)) {
                        khachHangList = response.data;
                    } else {
                        console.error('Cấu trúc dữ liệu khách hàng không đúng:', response.data);
                        khachHangList = [];
                    }

                    // Điền danh sách khách hàng vào dropdown
                    const khachHangSelect = document.getElementById('khachHang');
                    khachHangSelect.innerHTML = '<option value="">-- Chọn khách hàng --</option>';

                    khachHangList.forEach(khachHang => {
                        const option = document.createElement('option');
                        option.value = khachHang['idkh'] || khachHang.ID;
                        option.textContent = khachHang['Họ tên'] || khachHang.Ten;
                        khachHangSelect.appendChild(option);
                    });

                    hideLoading();
                } catch (error) {
                    console.error('Lỗi khi tải danh sách khách hàng:', error);
                    hideLoading();
                    showAlert('error', 'Lỗi kết nối', 'Không thể tải danh sách khách hàng. Vui lòng thử lại sau.');
                }
            }

            // Tải danh sách nhân viên
            async function loadNhanVienList() {
                try {
                    showLoading('Đang tải danh sách nhân viên...');

                    const response = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${appSheetConfig.appId}/tables/${appSheetConfig.tables.nhanVien}/Action`,
                        headers: {
                            'ApplicationAccessKey': appSheetConfig.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Find",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh",
                                "Selector": `Filter(${appSheetConfig.tables.nhanVien}, true)`
                            }
                        }
                    });

                    if (response.data && response.data.Rows) {
                        nhanVienList = response.data.Rows;
                    } else if (Array.isArray(response.data)) {
                        nhanVienList = response.data;
                    } else {
                        console.error('Cấu trúc dữ liệu nhân viên không đúng:', response.data);
                        nhanVienList = [];
                    }

                    // Điền danh sách nhân viên vào dropdown
                    const nhanVienSelect = document.getElementById('nhanVienBanHang');
                    nhanVienSelect.innerHTML = '<option value="">-- Chọn nhân viên --</option>';

                    nhanVienList.forEach(nhanVien => {
                        const option = document.createElement('option');
                        option.value = nhanVien['ID'] || nhanVien.ID;
                        option.textContent = nhanVien['Tên nhân viên'] || nhanVien.Ten;
                        nhanVienSelect.appendChild(option);
                    });

                    hideLoading();
                } catch (error) {
                    console.error('Lỗi khi tải danh sách nhân viên:', error);
                    hideLoading();
                }
            }

            // Tải danh sách sản phẩm từ kho
            async function loadSKUList() {
                try {
                    showLoading('Đang tải danh sách SKU...');

                    const response = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${appSheetConfig.appId}/tables/${appSheetConfig.tables.kho}/Action`,
                        headers: {
                            'ApplicationAccessKey': appSheetConfig.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Find",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh",
                                "Selector": `Filter(${appSheetConfig.tables.kho}, true)`
                            }
                        }
                    });

                    if (response.data && response.data.Rows) {
                        skuList = response.data.Rows;
                        console.log('Loaded SKU list:', skuList);
                    } else if (Array.isArray(response.data)) {
                        skuList = response.data;
                    } else {
                        console.error('Cấu trúc dữ liệu Kho không đúng:', response.data);
                        skuList = [];
                    }

                    // Điền danh sách sản phẩm vào sidebar
                    populateProductList(skuList);

                    hideLoading();
                    return skuList;
                } catch (error) {
                    console.error('Lỗi khi tải danh sách SKU:', error);
                    hideLoading();
                    return [];
                }
            }

            // Điền danh sách sản phẩm vào sidebar
            function populateProductList(products) {
                const productList = document.getElementById('productList');
                const categoryContainer = document.getElementById('categoryContainer');

                // Xóa dữ liệu cũ
                productList.innerHTML = '';

                // Giữ lại nút "Tất cả" và xóa các nút phân loại khác
                categoryContainer.innerHTML = '<button class="px-3 py-1 rounded bg-blue-500 text-white font-medium category-filter" data-category="all">Tất cả</button>';

                // Lấy danh sách phân loại
                const categories = new Set();

                products.forEach(product => {
                    const category = product['Nhóm Sản Phẩm'] || 'Khác';
                    categories.add(category);

                    const listItem = document.createElement('li');
                    listItem.className = 'py-3 flex justify-between items-center hover:bg-gray-50 px-2 rounded-lg cursor-pointer product-item';
                    listItem.dataset.id = product['ID'] || product.ID;
                    listItem.dataset.category = category;
                    listItem.innerHTML = `
                        <div>
                            <h4 class="font-medium text-gray-800">${product['Tên sản phẩm'] || product.Ten}</h4>
                            <div class="text-sm text-gray-500">SKU: ${product['SKU'] || product.SKU}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium text-gray-900">${formatCurrency(product['Giá lẻ'] || product.GiaBan)}</div>
                            <div class="text-xs text-gray-500">${product['Đvt'] || product.DonViTinh}</div>
                        </div>
                    `;
                    productList.appendChild(listItem);

                    // Thêm sự kiện click để thêm sản phẩm vào đơn hàng
                    // Bằng đoạn code này:
                    listItem.addEventListener('click', function () {
                        const productData = {
                            id: product['ID'] || product.ID,
                            sku: product['SKU'] || product.SKU,
                            name: product['Tên sản phẩm'] || product.Ten,
                            unit: product['Đvt'] || product.DonViTinh,
                            price: product['Giá lẻ'] || product.GiaBan,
                            priceWholesale: product['Giá sỉ'] || product.GiaSi,
                            category: category,
                            tonKho: product['Tồn kho'] || product.TonKho || 0
                        };

                        addProductToOrder(productData);

                        // Hiển thị thông báo toast khi thêm sản phẩm từ sidebar
                        showToast('success',
                            `Đã thêm "${productData.name}" vào đơn hàng`);
                    });
                });

                // Thêm các nút phân loại
                categories.forEach(category => {
                    const button = document.createElement('button');
                    button.className = 'px-3 py-1 rounded bg-gray-200 text-gray-700 font-medium category-filter';
                    button.dataset.category = category;
                    button.textContent = category;
                    categoryContainer.appendChild(button);

                    // Thêm sự kiện lọc sản phẩm theo phân loại
                    button.addEventListener('click', function () {
                        filterProductsByCategory(category);
                        document.querySelectorAll('.category-filter').forEach(btn => {
                            btn.classList.remove('bg-blue-500', 'text-white');
                            btn.classList.add('bg-gray-200', 'text-gray-700');
                        });
                        this.classList.remove('bg-gray-200', 'text-gray-700');
                        this.classList.add('bg-blue-500', 'text-white');
                    });
                });

                // Đặt lại sự kiện cho nút "Tất cả"
                document.querySelector('.category-filter[data-category="all"]').addEventListener('click', function () {
                    filterProductsByCategory('all');
                    document.querySelectorAll('.category-filter').forEach(btn => {
                        btn.classList.remove('bg-blue-500', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    this.classList.remove('bg-gray-200', 'text-gray-700');
                    this.classList.add('bg-blue-500', 'text-white');
                });
            }

            // Lọc sản phẩm theo danh mục
            function filterProductsByCategory(category) {
                const productItems = document.querySelectorAll('.product-item');
                productItems.forEach(item => {
                    if (category === 'all' || item.dataset.category === category) {
                        item.classList.remove('hidden');
                    } else {
                        item.classList.add('hidden');
                    }
                });
            }

            // Tìm thông tin sản phẩm theo SKU
            async function findProductBySKU(sku) {
                try {
                    // Tìm trong danh sách đã lưu trước
                    const cachedProduct = skuList.find(item => item.SKU === sku || item['SKU'] === sku);
                    if (cachedProduct) return cachedProduct;

                    // Nếu không tìm thấy, truy vấn API
                    showLoading('Đang tìm thông tin sản phẩm...');

                    const response = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${appSheetConfig.appId}/tables/${appSheetConfig.tables.kho}/Action`,
                        headers: {
                            'ApplicationAccessKey': appSheetConfig.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Find",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh",
                                "Selector": `Filter(${appSheetConfig.tables.kho}, [SKU]="${sku}")`
                            }
                        }
                    });

                    hideLoading();

                    if (response.data && response.data.Rows && response.data.Rows.length > 0) {
                        return response.data.Rows[0];
                    }

                    return null;
                } catch (error) {
                    console.error('Lỗi khi tìm sản phẩm:', error);
                    hideLoading();
                    return null;
                }
            }

            // Thêm khách hàng mới
            async function addNewCustomer(customerData) {
                try {
                    showLoading('Đang thêm khách hàng mới...');

                    const response = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${appSheetConfig.appId}/tables/${appSheetConfig.tables.khachHang}/Action`,
                        headers: {
                            'ApplicationAccessKey': appSheetConfig.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Add",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh"
                            },
                            "Rows": [customerData]
                        }
                    });

                    hideLoading();

                    if (response.status === 200) {
                        return response.data;
                    } else {
                        throw new Error("Thêm khách hàng không thành công");
                    }
                } catch (error) {
                    console.error('Lỗi khi thêm khách hàng:', error);
                    hideLoading();
                    throw error;
                }
            }

            // Lưu đơn hàng
            async function saveOrder(orderData, detailsData) {
                try {
                    showLoading('Đang lưu đơn hàng...');

                    // Lưu đơn hàng
                    const orderResponse = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${appSheetConfig.appId}/tables/${appSheetConfig.tables.donHang}/Action`,
                        headers: {
                            'ApplicationAccessKey': appSheetConfig.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Add",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh"
                            },
                            "Rows": [orderData]
                        }
                    });

                    if (orderResponse.status !== 200) {
                        throw new Error("Lưu đơn hàng không thành công");
                    }

                    const orderId = orderResponse.data.Rows[0].idban;

                    // Lưu chi tiết đơn hàng
                    const detailsResponse = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${appSheetConfig.appId}/tables/${appSheetConfig.tables.chiTietDonHang}/Action`,
                        headers: {
                            'ApplicationAccessKey': appSheetConfig.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Add",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh"
                            },
                            "Rows": detailsData.map(item => ({
                                ...item,
                                'idban': orderId
                            }))
                        }
                    });

                    hideLoading();

                    if (detailsResponse.status !== 200) {
                        throw new Error("Lưu chi tiết đơn hàng không thành công");
                    }

                    return {
                        order: orderResponse.data,
                        details: detailsResponse.data
                    };
                } catch (error) {
                    console.error('Lỗi khi lưu đơn hàng:', error);
                    hideLoading();
                    throw error;
                }
            }

            // =============== UI FUNCTIONS ===============

            // Format currency
            function formatCurrency(value, includeSymbol = true) {
                if (value === null || value === undefined || isNaN(value)) return "0";
                return new Intl.NumberFormat('vi-VN', {
                    style: includeSymbol ? 'currency' : 'decimal',
                    currency: 'VND',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            }

            // Parse currency - make sure this properly converts formatted strings to numbers
            function parseCurrency(currencyString) {
                if (!currencyString) return 0;
                // Remove all non-numeric characters except decimal separator
                const numericValue = String(currencyString).replace(/\./g, '')
                    .replace(/,/g, '.')
                    .replace(/[^\d.-]/g, '');
                return parseFloat(numericValue) || 0;
            }

            // Add product to order
            function addProductToOrder(product) {
                // Check if product already exists in order by SKU
                const existingItemIndex = orderItems.findIndex(item => item.sku === product.sku);

                if (existingItemIndex !== -1) {
                    // Cập nhật số lượng và tổng tiền
                    orderItems[existingItemIndex].quantity += 1;
                    updateItemTotal(orderItems[existingItemIndex]);
                } else {
                    // Thêm sản phẩm mới vào đơn hàng
                    orderItems.push({
                        id: product.id,
                        sku: product.sku,
                        name: product.name,
                        unit: product.unit,
                        quantity: 1,
                        price: product.price,
                        priceWholesale: product.priceWholesale || 0,
                        total: product.price, // Tính tổng tiền ban đầu
                        priceType: 'Giá lẻ',
                        note: ''
                    });
                }

                renderOrderItems();
                updateTotals();

                // Hiển thị phần chi tiết nếu ẩn
                document.getElementById('chiTietSection').classList.remove('hidden');
            }

            // Cập nhật hàm renderOrderItems để xử lý các sự kiện đúng
            // Cập nhật hàm renderOrderItems để xử lý các sự kiện đúng
            function renderOrderItems() {
                const chiTietTableBody = document.getElementById('chiTietTableBody');
                chiTietTableBody.innerHTML = '';

                orderItems.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td class="px-3 py-2 whitespace-nowrap">${index + 1}</td>
            <td class="px-3 py-2 whitespace-nowrap">${item.sku}</td>
            <td class="px-3 py-2">${item.name}</td>
            <td class="px-3 py-2 whitespace-nowrap">${item.unit}</td>
            <td class="px-3 py-2 whitespace-nowrap">
                <div class="flex items-center">
                    <button class="quantity-decrease px-2 py-1 bg-gray-200 rounded-l-lg">-</button>
                    <input type="number" class="quantity-input w-12 text-center border-y border-gray-200 py-1" value="${item.quantity}" min="1">
                    <button class="quantity-increase px-2 py-1 bg-gray-200 rounded-r-lg">+</button>
                </div>
            </td>
            <td class="px-3 py-2 whitespace-nowrap">${formatCurrency(item.price)}</td>
            <td class="px-3 py-2 whitespace-nowrap">${formatCurrency(item.total)}</td>
            <td class="px-3 py-2 whitespace-nowrap">
                <select class="price-type border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="Giá lẻ" ${item.priceType === 'Giá lẻ' ? 'selected' : ''}>Giá lẻ</option>
                    <option value="Giá sỉ" ${item.priceType === 'Giá sỉ' ? 'selected' : ''}>Giá sỉ</option>
                </select>
            </td>
            <td class="px-3 py-2">
                <input type="text" class="item-note border border-gray-300 rounded px-2 py-1 w-full text-sm" value="${item.note}">
            </td>
            <td class="px-3 py-2 whitespace-nowrap text-center">
                <button class="delete-item text-red-500 hover:text-red-700" data-index="${index}">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;
                    chiTietTableBody.appendChild(row);

                    // Các event listeners
                    const decreaseBtn = row.querySelector('.quantity-decrease');
                    const increaseBtn = row.querySelector('.quantity-increase');
                    const quantityInput = row.querySelector('.quantity-input');
                    const deleteBtn = row.querySelector('.delete-item');
                    const priceTypeSelect = row.querySelector('.price-type');
                    const noteInput = row.querySelector('.item-note');

                    decreaseBtn.addEventListener('click', function () {
                        if (item.quantity > 1) {
                            item.quantity -= 1;
                            quantityInput.value = item.quantity;
                            updateItemTotal(item);
                            row.cells[6].textContent = formatCurrency(item.total);
                            updateTotals();
                        }
                    });

                    increaseBtn.addEventListener('click', function () {
                        item.quantity += 1;
                        quantityInput.value = item.quantity;
                        updateItemTotal(item);
                        row.cells[6].textContent = formatCurrency(item.total);
                        updateTotals();
                    });

                    quantityInput.addEventListener('change', function () {
                        const newQuantity = parseInt(this.value);
                        if (newQuantity > 0) {
                            item.quantity = newQuantity;
                            updateItemTotal(item);
                            row.cells[6].textContent = formatCurrency(item.total);
                            updateTotals();
                        } else {
                            this.value = item.quantity;
                        }
                    });

                    deleteBtn.addEventListener('click', function () {
                        // Sử dụng chỉ số từ thuộc tính data-index để xóa đúng sản phẩm
                        const itemIndex = parseInt(this.getAttribute('data-index'));
                        orderItems.splice(itemIndex, 1);
                        renderOrderItems();
                        updateTotals();

                        // Ẩn phần chi tiết nếu không còn sản phẩm nào
                        if (orderItems.length === 0) {
                            document.getElementById('chiTietSection').classList.add('hidden');
                        }
                    });

                    priceTypeSelect.addEventListener('change', function () {
                        const newPriceType = this.value;
                        item.priceType = newPriceType;

                        // Cập nhật giá dựa trên loại giá
                        if (newPriceType === 'Giá sỉ' && item.priceWholesale) {
                            item.price = item.priceWholesale;
                        } else {
                            // Lấy giá lẻ từ danh sách sản phẩm
                            const product = skuList.find(p => p.SKU === item.sku || p['SKU'] === item.sku);
                            if (product) {
                                item.price = product['Giá lẻ'] || product.GiaBan || 0;
                            }
                        }

                        updateItemTotal(item);
                        row.cells[5].textContent = formatCurrency(item.price);
                        row.cells[6].textContent = formatCurrency(item.total);
                        updateTotals();
                    });

                    noteInput.addEventListener('input', function () {
                        item.note = this.value;
                    });
                });

                // Update data status text
                const dataStatusText = document.getElementById('dataStatusText');
                dataStatusText.textContent = `Tổng số ${orderItems.length} sản phẩm`;
            }

            // Cập nhật tổng tiền của một sản phẩm
            function updateItemTotal(item) {
                item.total = item.quantity * item.price;
            }

            // Update totals
            // Update totals function needs to be modified to ensure proper calculation
            function updateTotals() {
                // Calculate total correctly - ensure numeric addition, not string concatenation
                const total = orderItems.reduce((sum, item) => sum + Number(item.total), 0);

                // Get discount and shipping values
                const discountType = document.getElementById('phanLoaiGiamGia').value;
                let discountAmount = 0;

                if (discountType === 'Giảm giá theo tiền') {
                    discountAmount = parseCurrency(document.getElementById('giamGiaTheoTien').value);
                } else if (discountType === 'Giảm giá theo phần trăm') {
                    const discountPercent = parseFloat(document.getElementById('giamGiaTheoPhanTram').value) || 0;
                    discountAmount = (total * discountPercent) / 100;
                }

                const shippingFee = parseCurrency(document.getElementById('phiShip').value);
                const paidAmount = parseCurrency(document.getElementById('daThanhToan').value);

                // Calculate remaining amount
                const totalAfterDiscount = total - discountAmount;
                const finalTotal = totalAfterDiscount + shippingFee;
                const remainingAmount = finalTotal - paidAmount;

                // Update form fields - ensure values are properly formatted
                document.getElementById('tongTienHang').value = formatCurrency(total, false);
                document.getElementById('giamGia').value = formatCurrency(discountAmount, false);
                document.getElementById('conlaiPhaithanhtoan').value = formatCurrency(remainingAmount, false);

                // Update display
                document.getElementById('totalBeforeDiscount').textContent = formatCurrency(total);
                document.getElementById('totalDiscount').textContent = formatCurrency(discountAmount);
                document.getElementById('shippingFeeDisplay').textContent = formatCurrency(shippingFee);
                document.getElementById('paidAmountDisplay').textContent = formatCurrency(paidAmount);
                document.getElementById('remainingTotal').textContent = formatCurrency(remainingAmount);
            }

            // Lưu đơn hàng vào AppSheet
            async function handleSaveAll() {
                try {
                    // Kiểm tra các trường bắt buộc
                    const khachHangId = document.getElementById('khachHang').value;
                    if (!khachHangId) {
                        showAlert('warning', 'Thiếu thông tin', 'Vui lòng chọn khách hàng');
                        return;
                    }

                    const ngayDatHang = document.getElementById('ngayDatHang').value;
                    if (!ngayDatHang) {
                        showAlert('warning', 'Thiếu thông tin', 'Vui lòng chọn ngày đặt hàng');
                        return;
                    }

                    if (orderItems.length === 0) {
                        showAlert('warning', 'Chưa có sản phẩm', 'Vui lòng thêm ít nhất một sản phẩm vào đơn hàng');
                        return;
                    }

                    // Tạo dữ liệu đơn hàng
                    const maDonHang = document.getElementById('maDonHang').value;
                    const nhanVienId = document.getElementById('nhanVienBanHang').value;
                    const ghiChu = document.getElementById('ghiChu').value;
                    const ngayGiaoHangDuKien = document.getElementById('ngayGiaoHangDuKien').value;
                    const tongTienHang = parseCurrency(document.getElementById('tongTienHang').value);
                    const giamGia = parseCurrency(document.getElementById('giamGia').value);
                    const phiShip = parseCurrency(document.getElementById('phiShip').value);
                    const daThanhToan = parseCurrency(document.getElementById('daThanhToan').value);
                    const conlaiPhaithanhtoan = parseCurrency(document.getElementById('conlaiPhaithanhtoan').value);
                    const phanLoaiGiamGia = document.getElementById('phanLoaiGiamGia').value;
                    const trangThai = document.getElementById('trangThai').value;
                    const phuongThucThanhToan = document.getElementById('phuongThucThanhToan').value;
                    const paymentMethod = document.getElementById('paymentMethod').value;
                    const paymentNote = document.getElementById('paymentNote').value;

                    // Tạo dữ liệu đơn hàng theo cấu trúc AppSheet
                    const orderData = {
                        'idkh': khachHangId,
                        'Tổng tiền': tongTienHang,
                        'Ghi chú': ghiChu,
                        'Phân loại giảm giá': phanLoaiGiamGia,
                        'Giảm giá theo tiền': parseCurrency(document.getElementById('giamGiaTheoTien').value),
                        'Giảm giá theo phần trăm': parseFloat(document.getElementById('giamGiaTheoPhanTram').value) || 0,
                        'Còn phải thanh toán': conlaiPhaithanhtoan,
                        'Đã thanh toán': daThanhToan,
                        'Phí ship': phiShip,
                        // 'Giảm giá': giamGia,
                        'Phương thức thanh toán': phuongThucThanhToan
                    };

                    // Tạo dữ liệu chi tiết đơn hàng
                    const detailsData = orderItems.map((item, index) => ({
                        'SKU': item.sku,
                        'Số lượng': item.quantity,
                        'STT': index + 1
                    }));

                    // Lưu đơn hàng vào AppSheet
                    const result = await saveOrder(orderData, detailsData);

                    showAlert('success', 'Thành công', 'Đơn hàng đã được lưu thành công').then(() => {
                        // Reset form sau khi lưu thành công
                        resetForm();
                    });
                } catch (error) {
                    console.error('Lỗi khi lưu đơn hàng:', error);
                    showAlert('error', 'Lỗi', 'Đã xảy ra lỗi khi lưu đơn hàng. Vui lòng thử lại sau.');
                }
            }

            // Reset form
            function resetForm() {
                document.getElementById('donHangForm').reset();
                document.getElementById('maDonHang').value = generateOrderId();
                document.getElementById('ngayDatHang').value = today;
                document.getElementById('ngayGiaoHangDuKien').value = today;
                orderItems = [];
                renderOrderItems();
                updateTotals();
                document.getElementById('chiTietSection').classList.add('hidden');
            }

            // Xử lý thêm khách hàng mới
            async function handleThemKhachHang(event) {
                event.preventDefault();

                try {
                    const customerData = {
                        'Họ tên': document.getElementById('tenKhachHang').value,
                        'SĐT': document.getElementById('soDienThoai').value,
                        'Địa chỉ': document.getElementById('diaChi').value,
                        'Email': document.getElementById('email').value,
                    };

                    const result = await addNewCustomer(customerData);

                    // Đóng modal
                    closeKhachHangModal();

                    // Thêm khách hàng mới vào dropdown và chọn nó
                    await loadKhachHangList();

                    showAlert('success', 'Thành công', 'Đã thêm khách hàng mới thành công');
                } catch (error) {
                    console.error('Lỗi khi thêm khách hàng:', error);
                    showAlert('error', 'Lỗi', 'Đã xảy ra lỗi khi thêm khách hàng mới. Vui lòng thử lại sau.');
                }
            }

            // Mở modal thêm khách hàng
            function openKhachHangModal() {
                document.getElementById('themKhachHangModal').classList.remove('hidden');
            }

            // Đóng modal thêm khách hàng
            function closeKhachHangModal() {
                document.getElementById('themKhachHangModal').classList.add('hidden');
                document.getElementById('khachHangForm').reset();
            }

            // Sự kiện tìm kiếm sản phẩm
            document.getElementById('productSearch').addEventListener('input', function (e) {
                const searchTerm = e.target.value.toLowerCase();
                const productItems = document.querySelectorAll('.product-item');

                productItems.forEach(item => {
                    const productName = item.querySelector('h4').textContent.toLowerCase();
                    const productSku = item.querySelector('.text-sm').textContent.toLowerCase();

                    if (productName.includes(searchTerm) || productSku.includes(searchTerm)) {
                        item.classList.remove('hidden');
                    } else {
                        item.classList.add('hidden');
                    }
                });
            });

            // Update discount fields based on discount type
            document.getElementById('phanLoaiGiamGia').addEventListener('change', function () {
                const discountType = this.value;
                const moneyDiscount = document.getElementById('giamGiaTheoTien');
                const percentDiscount = document.getElementById('giamGiaTheoPhanTram');

                if (discountType === 'Giảm giá theo tiền') {
                    moneyDiscount.removeAttribute('readonly');
                    percentDiscount.setAttribute('readonly', true);
                    percentDiscount.value = '0';
                } else if (discountType === 'Giảm giá theo phần trăm') {
                    percentDiscount.removeAttribute('readonly');
                    moneyDiscount.setAttribute('readonly', true);
                    moneyDiscount.value = '0';
                } else {
                    moneyDiscount.setAttribute('readonly', true);
                    percentDiscount.setAttribute('readonly', true);
                    moneyDiscount.value = '0';
                    percentDiscount.value = '0';
                }

                updateTotals();
            });

            // Input fields for updating totals
            document.getElementById('giamGiaTheoTien').addEventListener('input', updateTotals);
            document.getElementById('giamGiaTheoPhanTram').addEventListener('input', updateTotals);
            document.getElementById('daThanhToan').addEventListener('input', updateTotals);
            document.getElementById('phiShip').addEventListener('change', updateTotals);

            // Setup event listeners for sidebar toggling
            const sidebar = document.getElementById('sidebar');
            const sidebarCollapsed = document.getElementById('sidebarCollapsed');
            const toggleSidebar = document.getElementById('toggleSidebar');
            const expandSidebar = document.getElementById('expandSidebar');
            const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
            const closeMobileSidebar = document.getElementById('closeMobileSidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            toggleSidebar.addEventListener('click', function () {
                sidebar.classList.add('transform', '-translate-x-full');
                sidebar.classList.remove('md:translate-x-0');
                sidebarCollapsed.classList.remove('hidden');
            });

            expandSidebar.addEventListener('click', function () {
                sidebar.classList.remove('transform', '-translate-x-full');
                sidebar.classList.add('md:translate-x-0');
                sidebarCollapsed.classList.add('hidden');
            });

            mobileSidebarToggle.addEventListener('click', function () {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            });

            closeMobileSidebar.addEventListener('click', function () {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });

            sidebarOverlay.addEventListener('click', function () {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });

            // Category toggle
            const categoryHeader = document.getElementById('categoryHeader');
            const categoryContent = document.getElementById('categoryContent');
            const categoryToggleIcon = document.getElementById('categoryToggleIcon');

            categoryHeader.addEventListener('click', function () {
                categoryContent.classList.toggle('hidden');
                categoryToggleIcon.classList.toggle('fa-chevron-down');
                categoryToggleIcon.classList.toggle('fa-chevron-up');
            });

            // Form buttons
            document.getElementById('btnThemKhachHang').addEventListener('click', openKhachHangModal);
            document.getElementById('closeKhachHangModal').addEventListener('click', closeKhachHangModal);
            document.getElementById('cancelKhachHangBtn').addEventListener('click', closeKhachHangModal);
            document.getElementById('khachHangForm').addEventListener('submit', handleThemKhachHang);
            document.getElementById('saveAll').addEventListener('click', handleSaveAll);
            document.getElementById('resetFormBtn').addEventListener('click', function () {
                if (confirm('Bạn có chắc muốn làm mới form? Tất cả dữ liệu sẽ bị mất.')) {
                    resetForm();
                }
            });
            document.getElementById('cancelBtn').addEventListener('click', function () {
                if (confirm('Bạn có chắc muốn hủy đơn hàng này?')) {
                    document.getElementById('chiTietTableBody').innerHTML = '';
                    document.getElementById('chiTietSection').classList.add('hidden');
                    orderItems = [];
                    updateTotals();
                }
            });

            // Initialize data
            async function initData() {
                try {
                    await testAppSheetConnection();
                    await Promise.all([
                        loadKhachHangList(),
                        loadNhanVienList(),
                        loadSKUList()
                    ]);

                    // Thiết lập scanner barcode
                    setupBarcodeScanner();
                    setupBarcodeEvents();
                } catch (error) {
                    console.error('Lỗi khởi tạo dữ liệu:', error);
                    showAlert('error', 'Lỗi kết nối', 'Không thể tải dữ liệu từ AppSheet. Vui lòng thử lại sau.');
                }
            }

            // Khởi tạo ứng dụng
            initData();
        });
    </script>
</body>

</html>